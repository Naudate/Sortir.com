{% extends 'base.html.twig' %}

{% block title %}Création d'une Sortie{% endblock %}

{% block body %}
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 sm:py-12 lg:px-8">
        <div class="mx-auto max-w-2xl">

            {% for message in app.flashes('success') %}
                <p class="mt-1 text-sm leading-6 text-green-700">{{ message }}</p>
            {% endfor %}

            {{ form_start(form) }}

            {{ form_errors(form) }}
            <div class="space-y-12">
                <div class="border-b border-gray-900/10 pb-12">
                    <h2 class="text-base font-semibold leading-7 text-gray-900">
                        Création d'une sortie
                    </h2>
                    <p class="mt-1 text-sm leading-6 text-gray-600">
                        Espace pour la création d'une sortie.
                    </p>
                    <div class="mt-6 border-gray-100">
                        {{ form_label(form.nom, null, {
                            'label_attr' : { 'class': 'after:content-["*"] after:ml-0.5
                             after:text-red-500 text-gray-800'}
                        }) }}
                        {{ form_errors(form.nom) }}
                        {{ form_widget(form.nom) }}
                        {{ form_help(form.nom) }}
                    </div>
                    <div class="grid md:grid-cols-3 gap-x-3">
                        <div class="mt-6 border-gray-100">
                            {{ form_label(form.dateHeureDebut, null, {
                                'label_attr' : { 'class': 'after:content-["*"] after:ml-0.5
                             after:text-red-500 text-gray-800'}
                            }) }}
                            {{ form_widget(form.dateHeureDebut) }}
                            {{ form_help(form.dateHeureDebut) }}
                            {{ form_errors(form.dateHeureDebut) }}
                        </div>
                        <div class="mt-6 border-gray-100">
                            {{ form_label(form.dateHeureFin, null, {
                                'label_attr' : { 'class': 'after:content-["*"] after:ml-0.5
                             after:text-red-500 text-gray-800'}
                            }) }}
                            {{ form_widget(form.dateHeureFin) }}
                            {{ form_help(form.dateHeureFin) }}
                            {{ form_errors(form.dateHeureFin) }}
                        </div>
                        <div class="mt-6 border-gray-100">
                            {{ form_label(form.dateLimiteInscription, null, {
                                'label_attr' : { 'class': 'after:content-["*"] after:ml-0.5
                             after:text-red-500 text-gray-800'}
                            }) }}
                            {{ form_widget(form.dateLimiteInscription) }}
                            {{ form_help(form.dateLimiteInscription) }}
                            {{ form_errors(form.dateLimiteInscription) }}
                        </div>
                    </div>
                    <div class="mt-6 border-gray-100">
                        {{ form_label(form.nombreMaxParticipant, null, {
                            'label_attr' : { 'class': 'after:content-["*"] after:ml-0.5
                             after:text-red-500 text-gray-800'}
                        }) }}
                        {{ form_widget(form.nombreMaxParticipant) }}
                        {{ form_help(form.nombreMaxParticipant) }}
                        {{ form_errors(form.nombreMaxParticipant) }}
                    </div>
                </div>
                <div class="border-b border-gray-900/10 pb-12">
                    <h2 class="text-base font-semibold leading-7 text-gray-900">
                        Description de la sortie
                    </h2>
                    <p class="mt-1 text-sm leading-6 text-gray-600">
                        Ajoutez une description de la sortie.
                    </p>
                    <div class="mt-6 border-gray-100">
                        {{ form_label(form.description) }}
                        {{ form_widget(form.description) }}
                        {{ form_help(form.description) }}
                        {{ form_errors(form.description) }}
                    </div>
                </div>
                <div class="border-b border-gray-900/10 pb-12">
                    <h2 class="text-base font-semibold leading-7 text-gray-900">
                        Informations sur le lieu et le site
                    </h2>
                    <p class="mt-1 text-sm leading-6 text-gray-600">
                        Ajoutez le lieu et la ville de la sortie ainsi que le site concerné.
                    </p>
                    <div class="mt-6 border-gray-100">
                        {{ form_label(form.site, null, {
                            'label_attr' : { 'class': 'after:content-["*"] after:ml-0.5
                             after:text-red-500 text-gray-800'}
                        }) }}
                        {{ form_widget(form.site) }}
                        {{ form_help(form.site) }}
                        {{ form_errors(form.site) }}
                    </div>
                    <div class="mt-6 border-gray-100">
                        {{ form_label(form.ville, null, {
                            'label_attr' : { 'class': 'after:content-["*"] after:ml-0.5
                             after:text-red-500 text-gray-800'}
                        }) }}
                        {{ form_widget(form.ville) }}
                        {{ form_help(form.ville) }}
                        {{ form_errors(form.ville) }}
                    </div>
                    <div class="mt-6 border-gray-100">
                        {{ form_label(form.lieu, null, {
                            'label_attr' : { 'class': 'after:content-["*"] after:ml-0.5
                             after:text-red-500 text-gray-800'}
                        }) }}
                        {{ form_widget(form.lieu) }}
                        {{ form_help(form.lieu) }}
                        {{ form_errors(form.lieu) }}
                        <button type="button" class=" mt-2 rounded-md bg-indigo-600 px-3 py-2
             text-sm font-semibold text-white shadow-sm hover:bg-indigo-500
             focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2
             focus-visible:outline-indigo-600" id="openModal">Ajouter un lieu</button>
                    </div>
                    <div class="mt-6 border-gray-100">
                                <p>Rue : <span id="rueChoose"></span></p>

                    </div>
                    <div class="mt-6 border-gray-100">

                        <p>Code Postal : <span id="codePostalChoose"></span></p>
                            </div>

                </div>
                <div class="grid grid-cols-3 gap-x-6 gap-y-6">
                    <div class="col-end-4">
                        <div class="flex items-center justify-end gap-x-6">
                            {{ form_row(form.enregistrer) }}
                            {{ form_row(form.publier) }}
                            <a id="sortie_annuler" href="{{ path('app_home') }}" class="text-base font-semibold leading-7 text-gray-900">Annuler</a>
                            {{ form_end(form) }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="pt-12">
                <div id="lieuModal" style="display: none;" class="border border-2 border-solid border-gray-400 rounded-md">
                    <div class="m-3">
                        {{ include('lieu/modal/addLieu.html.twig', {
                            modalTitle: 'Add a new Lieu',
                        }) }}
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}

    {{ parent() }}

    <script>

        function loadLieuByVille () {
            // Récupérez la valeur de la ville sélectionnée
            var selectedVille = $('#{{ form.ville.vars.id }}').val();

            // Faites une requête AJAX pour récupérer les lieux associés à la ville
            $.ajax({
                url: "{{ path('lieu_getByVille') }}",
                type: 'POST',
                data: {ville: selectedVille},
                success: function (response) {
                    $('#{{ form.lieu.vars.id }}').empty(); // Effacez les options existantes
                    if (response.length === 0) {
                        $('#{{ form.lieu.vars.id }}').append('<option> Cette ville n\'a pas de lieu</option>');
                    } else {
                        // Mettez à jour les options du champ "lieu" avec les données de la réponse JSON
                        $.each(response, function (index, lieu) {
                            $('#{{ form.lieu.vars.id }}').append('<option value="' + lieu.id + '">' + lieu.nom + '</option>');
                        });
                        loadLieuById();
                    }

                }
            });
        }

        function loadLieuById () {
            // Récupérez la valeur de la ville sélectionnée
            var selectedLieu = $('#{{ form.lieu.vars.id }}').val();

            // Faites une requête AJAX pour récupérer les lieux associés à la ville
            $.ajax({
                url: "{{ path('lieu_getByLieu') }}",
                type: 'POST',
                data: {lieu: selectedLieu},
                success: function (response) {
                    document.getElementById("rueChoose").innerText=response[0].rue;
                    document.getElementById("codePostalChoose").innerText=response[0].ville.codePostal;
                }
            });

        }

        document.addEventListener("DOMContentLoaded", function () {
            // Enregistrez les données du formulaire de sortie lors de la soumission du formulaire de lieu
            document.getElementById('lieu_form').addEventListener('submit', function () {
                var formDataSortie = {
                    nom: document.getElementById('sortie_nom').value,
                    dateHeureDebut: document.getElementById('sortie_dateHeureDebut').value,
                    dateHeureFin: document.getElementById('sortie_dateHeureFin').value,
                    dateLimiteInscription: document.getElementById('sortie_dateLimiteInscription').value,
                    nbMaxParticipant: document.getElementById('sortie_nombreMaxParticipant').value,
                    description: document.getElementById('sortie_description').value,
                    site: document.getElementById('sortie_site').value,
                    ville: document.getElementById('sortie_ville').value,
                    lieu: document.getElementById('sortie_lieu').value,

                };
                localStorage.setItem('formDataSortie', JSON.stringify(formDataSortie));
            });

            // Restaurez les données du formulaire de sortie si elles existent
            var formDataSortie = localStorage.getItem('formDataSortie');
            if (formDataSortie) {
                formDataSortie = JSON.parse(formDataSortie);
                document.getElementById('sortie_nom').value = formDataSortie.nom;
                document.getElementById('sortie_dateHeureDebut').value = formDataSortie.dateHeureDebut;
                document.getElementById('sortie_dateHeureFin').value = formDataSortie.dateHeureFin;
                document.getElementById('sortie_dateLimiteInscription').value = formDataSortie.dateLimiteInscription;
                document.getElementById('sortie_nombreMaxParticipant').value = formDataSortie.nbMaxParticipant;
                document.getElementById('sortie_description').value = formDataSortie.description;
                document.getElementById('sortie_site').value = formDataSortie.site;
                document.getElementById('sortie_ville').value = formDataSortie.ville;
                document.getElementById('sortie_lieu').value = formDataSortie.lieu;
                loadLieuByVille()
            }
        });

        // Attendez que le document soit prêt
        $(document).ready(function () {
            loadLieuByVille();
            var submitFormSortie = {{ submitFormSortie ? 'true' : 'false' }}
            if(!submitFormSortie){
                $('#{{ form.lieu.vars.id }}').empty(); // Effacez les options existantes
                $('#{{ form.lieu.vars.id }}').append('<option>Veuillez choisir une ville</option>');
            }else{
                loadLieuByVille();
            }
            // Écoutez les changements de la ville
            $('#{{ form.ville.vars.id }}').change(loadLieuByVille);
            $('#{{ form.lieu.vars.id }}').change(loadLieuById);

        });
    </script>
    <script>
        $(document).ready(function () {
            var errorLieu = {{ errorLieu ? 'true' : 'false' }}
            if (errorLieu === true)
            {
                $('#lieuModal').show();
                $('#closeModal').show();
                $('#openModal').hide();
            }
            // Écoutez le clic sur le bouton "Ajouter un lieu"
            $('#openModal').click(function () {
                // Affichez la modal
                $('#lieuModal').show();
                $('#closeModal').show();
                $('#openModal').hide();
            });

            $('#closeModal').click(function () {
                // Affichez la modal
                $('#lieuModal').hide();
                $('#openModal').show();
                $('#closeModal').hide();
            });
        });
    </script>



{% endblock %}
